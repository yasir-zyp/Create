<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.mall4j.cloud.product.mapper.SkuMapper">
  <resultMap id="skuMap" type="com.mall4j.cloud.product.model.Sku">
    <id column="sku_id" property="skuId" />
    <result column="create_time" property="createTime"/>
    <result column="update_time" property="updateTime"/>
    <result column="spu_id" property="spuId"/>
    <result column="sku_name" property="skuName"/>
    <result column="attrs" property="attrs"/>
    <result column="price_fee" property="priceFee"/>
    <result column="market_price_fee" property="marketPriceFee"/>
    <result column="status" property="status"/>
    <result column="integral" property="integral"/>
  </resultMap>

  <resultMap id="skuAndAttrMap" type="com.mall4j.cloud.api.product.vo.SkuVO" extends="com.mall4j.cloud.product.mapper.SkuMapper.skuMap">
    <collection property="skuAttrs" ofType="com.mall4j.cloud.api.product.vo.SkuAttrVO">
      <id column="sku_attr_id" property="skuAttrId" />
      <result column="create_time" property="createTime"/>
      <result column="update_time" property="updateTime"/>
      <result column="price_fee" property="priceFee"/>
      <result column="spu_id" property="spuId"/>
      <result column="sku_id" property="skuId"/>
      <result column="attr_id" property="attrId"/>
      <result column="status" property="status"/>
      <result column="attr_name" property="attrName"/>
    </collection>
  </resultMap>
  <sql id="Vo_Column_List">
    sku.`sku_id`,sku.`create_time`,sku.`update_time`,sku.sku_name,sku.`spu_id`,sku.`attrs`,
    sku.`price_fee`,sku.`market_price_fee`,sku.`status`

  </sql>

  <select id="listBySpuIdAndExtendInfo" resultMap="skuAndAttrMap">
    select   sku.`sku_id`,sku.`create_time`,sku.`update_time`,sku.sku_name,sku.`spu_id`,sku.`attrs`,
    sku.`price_fee`,sku.`market_price_fee`,sku.`status`,ss.sku_attr_id,ss.`attr_id`,ss.`attr_name`,
    ss.`attr_desc`,ss.price_fee
    from sku
    LEFT JOIN `sku_attr` ss ON ss.`sku_id` = sku.`sku_id`
    WHERE sku.`spu_id` = #{spuId} and sku.status <![CDATA[<>]]> -1
  </select>

  <select id="listBySpuId" resultMap="skuAndAttrMap">
    SELECT  sku.`sku_id`,sku.`create_time`,sku.`update_time`,sku.sku_name,sku.`spu_id`,sku.`attrs`,
    sku.`price_fee`,sku.`market_price_fee`,sku.`status`,sa.sku_attr_id,sa.`attr_id`,sa.`attr_name`,sa.`attr_desc`
    FROM sku sku
    LEFT JOIN `sku_attr` sa ON sa.`sku_id` = sku.`sku_id`
    WHERE sku.`spu_id` = #{spuId} and sku.status <![CDATA[<>]]> -1
  </select>

  <insert id="save">
    insert into sku (`spu_id`,`attrs`,`price_fee`,`market_price_fee`,`status`)
    values (#{sku.spuId},#{sku.attrs},#{sku.priceFee},#{sku.marketPriceFee},#{sku.status});
  </insert>

  <insert id="saveBatch" parameterType="java.util.List" useGeneratedKeys="true" keyProperty="skuId">
    insert into sku (`spu_id`,`sku_name`,`attrs`,`price_fee`,`market_price_fee`,`status`) values
    <foreach collection="skuList" item="sku" separator=",">
      (#{sku.spuId},#{sku.skuName},#{sku.attrs},#{sku.priceFee},#{sku.marketPriceFee},#{sku.status})
    </foreach>
  </insert>

  <update id="update">
    update sku
    set
      <if test="sku.spuId != null">
        `spu_id` = #{sku.spuId},
      </if>
      <if test="sku.attrs != null">
        `attrs` = #{sku.attrs},
      </if>
      <if test="sku.priceFee != null">
        `price_fee` = #{sku.priceFee},
      </if>
      <if test="sku.marketPriceFee != null">
        `market_price_fee` = #{sku.marketPriceFee},
      </if>
      <if test="sku.status != null">
        `status` = #{sku.status},
      </if>
    where sku_id = #{sku.skuId}
  </update>
  <delete id="deleteById">
    delete from sku where sku_id = #{skuId}
  </delete>

  <update id="updateBySpuId">
    update sku set status = -1 where spu_id = #{spuId}
  </update>

  <update id="updateBatch">
    <foreach collection="skus" separator=";" item="sku">
      update sku
      <set>
        <if test="sku.attrs != null">
          `attrs` = #{sku.attrs},
        </if>
        <if test="sku.priceFee != null">
          `price_fee` = #{sku.priceFee},
        </if>
        <if test="sku.marketPriceFee != null">
          `market_price_fee` = #{sku.marketPriceFee},
        </if>
        <if test="sku.status != null">
          `status` = #{sku.status},
        </if>
      </set>
      where sku_id = #{sku.skuId}
    </foreach>
  </update>
  <select id="getSkuBySkuId" resultType="com.mall4j.cloud.api.product.vo.SkuVO">
    select <include refid="Vo_Column_List"/> from sku  where sku_id = #{skuId}
  </select>
  <select id="getSkuBySpuId" resultMap="skuAndAttrMap">
    SELECT <include refid="Vo_Column_List"/>,sa.sku_attr_id,sa.`attr_id`,sa.`attr_name`,sa.`attr_desc`
    FROM sku sku
    LEFT JOIN `sku_attr` sa ON sa.`sku_id` = sku.`sku_id`
    WHERE sku.`spu_id` = #{spuId} and sku.status = 1
  </select>
</mapper>
